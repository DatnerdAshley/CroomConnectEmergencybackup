<script>
/* ================= SUPABASE ================= */

const supabaseClient = window.supabase.createClient(
  'https://jxxnfsydjrflnephmfjm.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eG5mc3lkanJmbG5lcGhtZmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTU1MjEsImV4cCI6MjA4MTM1NTUyMX0.dlhnK99ki1KT24WGqTsW_8n7TnTIDH2mfLyxKB50Hl4'
);

const PLACEHOLDER_DOMAIN = '@croomsconnect.local';

/* ================= REDIRECT LOCK (CRITICAL) ================= */

let redirected = false;

/* ================= AUTH STATE ================= */

supabaseClient.auth.onAuthStateChange((event, session) => {
  console.log('Auth event:', event);

  if (event === 'SIGNED_IN' && session && !redirected) {
    redirected = true; // ðŸ”’ prevent loop
    window.location.replace('connect.html');
  }
});

/* ================= SIGN IN ================= */

document.getElementById('sign-in-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const username = document.getElementById('signin-username').value.trim();
  const password = document.getElementById('signin-password').value;

  const { error } = await supabaseClient.auth.signInWithPassword({
    email: username + PLACEHOLDER_DOMAIN,
    password
  });

  if (error) {
    const msg = document.getElementById('auth-message');
    msg.textContent = 'Invalid username or password.';
    msg.classList.remove('hidden');
  }
});

/* ================= SIGN UP ================= */

document.getElementById('sign-up-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const username = document.getElementById('signup-username').value.trim();
  const password = document.getElementById('signup-password').value;

  const { data, error } = await supabaseClient.auth.signUp({
    email: username + PLACEHOLDER_DOMAIN,
    password
  });

  if (error) {
    alert(error.message);
    return;
  }

  await supabaseClient.from('profiles').insert({
    id: data.user.id,
    username
  });

  alert('Account created! Please sign in.');
});
</script>
