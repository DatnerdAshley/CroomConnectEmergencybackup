<!DOCTYPE html>
<html lang="en">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Crooms Connect - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
<div class="auth-card text-center">
    <h1 class="text-3xl font-extrabold text-white mb-6">Crooms Connect</h1>
    <p class="text-gray-400 mb-8">Sign in using your username and password.</p>

    <div id="auth-message" class="mb-4 p-3 rounded-lg text-sm hidden"></div>

    <form id="sign-in-form" class="space-y-4">
        <input id="signin-username" required placeholder="Username" class="w-full">
        <input id="signin-password" type="password" required placeholder="Password" class="w-full">
        <button class="btn w-full">Sign In</button>
    </form>

    <form id="sign-up-form" class="space-y-4 hidden">
        <input id="signup-username" required placeholder="Choose a Username" class="w-full">
        <input id="signup-password" type="password" required placeholder="Password" class="w-full">
        <button class="btn w-full">Sign Up</button>
    </form>

    <button id="toggle-auth-view" class="mt-6 text-sm text-gray-400">
        Need an account? Sign Up
    </button>
</div>

<script>
/* ================= SUPABASE ================= */

const supabaseClient = window.supabase.createClient(
  'https://jxxnfsydjrflnephmfjm.supabase.co',
  'YOUR_PUBLIC_ANON_KEY'
);

const PLACEHOLDER_DOMAIN = '@croomsconnect.local';

/* ================= AUTH STATE (FIX) ================= */

// Wait for Supabase to restore auth before redirecting
supabaseClient.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_IN' && session) {
    window.location.replace('connect.html');
  }
});

/* ================= HANDLERS ================= */

document.getElementById('sign-in-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const email =
    document.getElementById('signin-username').value.trim() +
    PLACEHOLDER_DOMAIN;

  const password = document.getElementById('signin-password').value;

  const { error } = await supabaseClient.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    const msg = document.getElementById('auth-message');
    msg.textContent = 'Invalid username or password.';
    msg.classList.remove('hidden');
  }
});

document.getElementById('sign-up-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const username = document.getElementById('signup-username').value.trim();
  const password = document.getElementById('signup-password').value;

  const { data, error } = await supabaseClient.auth.signUp({
    email: username + PLACEHOLDER_DOMAIN,
    password
  });

  if (error) return alert(error.message);

  await supabaseClient.from('profiles').insert({
    id: data.user.id,
    username
  });

  alert('Account created! Please sign in.');
});
</script>
</body>
</html>
